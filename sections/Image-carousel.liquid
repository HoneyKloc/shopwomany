{% style %}
.image-carousel-section {
  padding-top: {{ section.settings.padding_top }}px;
  padding-bottom: {{ section.settings.padding_bottom }}px;
}
.image-carousel-section .image {
  width: calc((100% - ({{ section.settings.card_spacing }}px * ({{ section.settings.cards_per_row }} - 1))) / {{ section.settings.cards_per_row }});
  margin-right: {{ section.settings.card_spacing }}px;
}
.image-carousel-section .carousel-nav {
  background: {{ section.settings.nav_button_color }};
}
.image-carousel-section .carousel-nav svg > *{
  stroke: {{  section.settings.nav_button_text_color }};
}
@media screen and (max-width: 768px) {
  .image-carousel-section .image {
    width: calc((100% - ({{ section.settings.card_spacing }}px * ({{ section.settings.cards_per_row_mobile }} - 1))) / {{ section.settings.cards_per_row_mobile }});
  }
}
{% endstyle %}

<div class="section">
    <div class="image-carousel-section">
    {% if section.settings.heading != blank %}
        <div class="content-wrapper">
        <h2 class="heading">{{ section.settings.heading }}</h2>
        {% if section.settings.text != blank %}
            <div class="text">{{ section.settings.text }}</div>
        {% endif %}
        </div>
    {% endif %}

    <div class="carousel-wrapper">
        <div class="carousel-track">
        {% for block in section.blocks %}
            {% if block.settings.image != blank %}
            <div class="image image-{{ forloop.index }}">
                {{ block.settings.image | image_url: width: 780 | image_tag: loading: 'lazy' }}
            </div>
            {% endif %}
        {% endfor %}
        </div>

        {% assign image_count = section.blocks | size %}
        {% if image_count > section.settings.cards_per_row %}
        <button class="carousel-nav carousel-prev" data-prev aria-label="Previous slide">
            <svg style="transform: rotate(180deg);" width="26" height="25" viewBox="0 0 26 25" fill="none" xmlns="http://www.w3.org/2000/svg"><line y1="11.7659" x2="24" y2="11.7659" stroke="currentColor"/><path d="M10.5 0.265869C14.4241 6.51743 17.3133 9.12233 24 11.7659C17.2243 15.1496 14.0607 17.6794 10.5 24.2659" stroke="currentColor"/></svg>
        </button>

        <button class="carousel-nav carousel-next" data-next aria-label="Next slide">
            <svg width="26" height="25" viewBox="0 0 26 25" fill="none" xmlns="http://www.w3.org/2000/svg"><line y1="11.7659" x2="24" y2="11.7659" stroke="currentColor"/><path d="M10.5 0.265869C14.4241 6.51743 17.3133 9.12233 24 11.7659C17.2243 15.1496 14.0607 17.6794 10.5 24.2659" stroke="currentColor"/></svg>
        </button>
        {% endif %}

    </div>
  </div>
</div>

{% schema %}
{
    "name": "Image Carousel",
    "tag": "section",
    "class": "image-carousel",
    "settings": [
        {
            "type": "text",
            "id": "heading",
            "label": "Heading"
        },
        {
            "type": "richtext",
            "id": "text",
            "label": "Text"
        },
        {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "cards_per_row",
      "min": 1,
      "max": 3,
      "step": 0.5,
      "label": "Cards per row (desktop)",
      "default": 2
    },
    {
      "type": "select",
      "id": "cards_per_row_mobile",
      "label": "Cards per row (mobile)",
      "options": [
        {
          "value": "1",
          "label": "1"
        },
        {
          "value": "2",
          "label": "2"
        }
      ],
      "default": "1"
    },
    {
      "type": "range",
      "id": "card_spacing",
      "min": 0,
      "max": 40,
      "step": 4,
      "unit": "px",
      "label": "Card spacing",
      "default": 20
    },
    {
      "type": "header",
      "content": "Carousel settings"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Enable autoplay",
      "default": false
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "min": 2,
      "max": 10,
      "step": 1,
      "unit": "s",
      "label": "Autoplay speed",
      "default": 5
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "nav_button_color",
      "label": "Navigation button color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "nav_button_text_color",
      "label": "Navigation button text",
      "default": "#ffffff"
    },
        {
            "type": "header",
            "content": "Section Properties"
        },
        {
            "type": "text",
            "id": "custom_class",
            "label": "Class"
        },
        {
            "type":"range",
            "id": "padding_top",
            "label": "Padding top",
            "min": 0,
            "max": 100,
            "step": 2,
            "unit": "px",
            "default": 30
        },
        {
            "type":"range",
            "id": "padding_bottom",
            "label": "Padding bottom",
            "min": 0,
            "max": 100,
            "step": 2,
            "unit": "px",
            "default": 30
        },
    ],
    "blocks": [
        {
            "type": "image",
            "name": "Image",
            "settings": [
                {
                    "type": "image_picker",
                    "id": "image",
                    "label": "Image",
                    "info": "Dimension should be 780x480, jpg"
                }
            ]
        }
    ],
    "presets": [
        {
            "name": "Image Carousel"
        }
    ]

}
{% endschema %}

<script>
document.addEventListener("DOMContentLoaded", function () {
  const carousel = document.querySelector(".carousel-wrapper");
  if (!carousel) return;

  const track = carousel.querySelector(".carousel-track");
  const slides = Array.from(carousel.querySelectorAll(".image"));
  const prevButton = carousel.querySelector("[data-prev]");
  const nextButton = carousel.querySelector("[data-next]");

  const cardsPerRow = parseFloat({{ section.settings.cards_per_row }});
  const cardsPerRowMobile = parseFloat({{ section.settings.cards_per_row_mobile }});
  const autoplay = {{ section.settings.autoplay }};
  const autoplaySpeed = {{ section.settings.autoplay_speed | times: 1000 }};
  let currentIndex = 0;
  let autoplayTimer;

  function getVisibleCount() {
    return window.innerWidth <= 768 ? cardsPerRowMobile : cardsPerRow;
  }

  function getSlideWidth() {
    const style = getComputedStyle(slides[0]);
    const marginRight = parseInt(style.marginRight);
    return slides[0].offsetWidth + marginRight;
  }

  function getMaxIndex() {
    const visible = getVisibleCount();
    // Allow second-to-last to partially show, last fully visible
    return Math.max(0, slides.length - 1);
  }

  function updateCarousel() {
    const slideWidth = getSlideWidth();
    const visible = getVisibleCount();
    const totalWidth = slideWidth * slides.length;
    let offset;

    if (currentIndex >= slides.length - visible) {
      // Peek effect for last slide
      offset = totalWidth - slideWidth * visible; // last slide fully visible
    } else {
      offset = slideWidth * currentIndex;
    }

    track.style.transform = `translateX(-${offset}px)`;
  }

  function nextSlide() {
    const maxIndex = getMaxIndex();
    if (currentIndex >= maxIndex) currentIndex = 0;
    else currentIndex++;
    updateCarousel();
  }

  function prevSlide() {
    const maxIndex = getMaxIndex();
    if (currentIndex <= 0) currentIndex = maxIndex;
    else currentIndex--;
    updateCarousel();
  }

  function startAutoplay() {
    if (!autoplay || slides.length <= getVisibleCount()) return;
    stopAutoplay();
    autoplayTimer = setInterval(nextSlide, autoplaySpeed);
  }

  function stopAutoplay() {
    clearInterval(autoplayTimer);
  }

  // Initialize
  updateCarousel();
  if (autoplay) startAutoplay();

  // Events
  if (nextButton) nextButton.addEventListener("click", nextSlide);
  if (prevButton) prevButton.addEventListener("click", prevSlide);
  carousel.addEventListener("mouseenter", stopAutoplay);
  carousel.addEventListener("mouseleave", () => autoplay && startAutoplay());
  window.addEventListener("resize", updateCarousel);
});

</script>